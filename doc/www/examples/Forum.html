<!--# include file="head.html" -->

<h2>sample Forum application</h2>

<p>define user's table:</p>

<pre>
<b>create sequence</b> person_id;
<b>create table</b> person(
    id          bigint <b>default</b> nextval(<span class="red">'person_id'</span>) <b>primary key</b>,
    nickname    <span class="red">varchar</span>(<span class="blue">255</span>)   <b>not null</b>,
    password    <span class="red">varchar</span>(<span class="blue">40</span>)    <b>not null</b>,
    mail        <span class="red">varchar</span>(<span class="blue">128</span>)   <b>not null</b>,

    created     <span class="red">timestamp</span>      <b>not null</b>,
    last_login  <span class="red">timestamp</span>      <b>not null</b>,
    modified    <span class="red">timestamp</span>      <b>not null</b>
);
<b>create unique index</b> person_mail_uniq <b>on</b> person(<span class="blue">lower</span>(mail));
</pre>

<p>and it's business class:</p>

<pre>
    <span class="green">final class </span><span class="blue">Person </span><span class="green">extends </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FIdentifiableObject.class.php&rev=0&sc=0">IdentifiableObject</a> </span><span class="green">implements </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FDAOs%2FDAOConnected.class.php&rev=0&sc=0">DAOConnected</a>
    </span><span class="green">{
        private </span><span class="blue">$nickname    </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        private </span><span class="blue">$password    </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        
        private </span><span class="blue">$mail        </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        
        private </span><span class="blue">$created     </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        private </span><span class="blue">$modified    </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        private </span><span class="blue">$lastLogin   </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        
        public static function </span><span class="blue">create</span><span class="green">()
        {
            return new </span><span class="blue">Person</span><span class="green">();
        }

        public static function </span><span class="blue">dao</span><span class="green">()
        {
            return </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">person</span><span class="green">();
        }
        
        </span><span class="orange">/* quite boring {get,set}ters goes here */
    </span><span class="green">}</span>
</pre>

<p>forum's table:</p>

<pre>
<b>create sequence</b> forum_id;
<b>create table</b> forum(
    id              <span class="red">integer</span> default nextval(<span class="red">'forum_id'</span>) <b>primary key</b>,
    name            <span class="red">varchar</span>(<span class="blue">255</span>)    <b>not null</b>,
    description     text            null,
    created         <span class="red">timestamp</span>       <b>not null</b>,
    modified        <span class="red">timestamp</span>       <b>not null</b>,
    message_count   bigint          <b>not null</b>
);
</pre>

<p>forum's class:</p>

<pre>
    <span class="green">final class </span><span class="blue">Forum </span><span class="green">extends </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FNamedObject.class.php&rev=0&sc=0">NamedObject</a> </span><span class="green">implements </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FDAOs%2FDAOConnected.class.php&rev=0&sc=0">DAOConnected</a>
    </span><span class="green">{
        private </span><span class="blue">$description     </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        private </span><span class="blue">$messageCount    </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        
        private </span><span class="blue">$created         </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        private </span><span class="blue">$modified        </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        
        public static function </span><span class="blue">create</span><span class="green">()
        {
            return new </span><span class="blue">Forum</span><span class="green">();
        }
        
        public static function </span><span class="blue">dao</span><span class="green">()
        {
            return </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">forum</span><span class="green">();
        }

        </span><span class="orange">/* even more boring methods */
    </span><span class="green">}</span>
</pre>

<p>forum's message class finally:</p>

<pre>
<b>create sequence</b> message_id;
<b>create table</b> message(
    id          bigint <b>default</b> nextval(<span class="red">'message_id'</span>) <b>primary key</b>,

    forum_id    <span class="red">integer</span> <b>not null references</b> forum(<b>id</b>)
                <b>on delete restrict on update cascade,</b>

    person_id   <span class="red">bigint</span> <b>not null references</b> person(<b>id</b>)
                <b>on delete restrict on update cascade</b>,

    -- parent is null when top level
    parent_id   <span class="red">bigint</span> <b>null references</b> message(<b>id</b>)
                <b>on delete cascade on update cascade</b>,

    -- thread == id, when top level
    thread_id   <span class="red">bigint</span> <b>not null references</b> message(<b>id</b>)
                <b>on delete cascade on update cascade</b>,

    name        <span class="red">varchar</span>(<span class="blue">255</span>) <b>not null</b>,
    content     text <b>not null</b>,
    created     timestamp <b>not null</b>
);
</pre>

<p>and it's business class:</p>

<pre>
    <span class="green">final class </span><span class="blue">Message </span><span class="green">extends </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FNamedObject.class.php&rev=0&sc=0">NamedObject</a> </span><span class="green">implements </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FDAOs%2FDAOConnected.class.php&rev=0&sc=0">DAOConnected</a>
    </span><span class="green">{
        </span><span class="orange">// since we don't want to pollute our cache
        </span><span class="green">private </span><span class="blue">$forumId     </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        private </span><span class="blue">$parentId    </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        private </span><span class="blue">$threadId    </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        
        </span><span class="orange">// not reflected at DB in any way
        </span><span class="green">private </span><span class="blue">$count       </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        
        private </span><span class="blue">$person      </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        
        private </span><span class="blue">$content     </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        
        private </span><span class="blue">$created     </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        
        public static function </span><span class="blue">create</span><span class="green">()
        {
            return new </span><span class="blue">Message</span><span class="green">();
        }
        
        public static function </span><span class="blue">dao</span><span class="green">()
        {
            return </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">message</span><span class="green">();
        }
        
        </span><span class="orange">/* ok, this time you'll see all that boring stuff below */
        
        </span><span class="green">public function </span><span class="blue">getForumId</span><span class="green">()
        {
            return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">forumId</span><span class="green">;
        }
        
        public function </span><span class="blue">setForumId</span><span class="green">(</span><span class="blue">$id</span><span class="green">)
        {
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">forumId </span><span class="green">= </span><span class="blue">$id</span><span class="green">;
            
            return </span><span class="blue">$this</span><span class="green">;
        }
        
        public function </span><span class="blue">getParentId</span><span class="green">()
        {
            return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">parentId</span><span class="green">;
        }
        
        public function </span><span class="blue">setParentId</span><span class="green">(</span><span class="blue">$id</span><span class="green">)
        {
            </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FAssert.class.php&rev=0&sc=0">Assert</a></span><span class="green">::</span><span class="blue">isTrue</span><span class="green">(
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">id </span><span class="green">=== </span><span class="blue">null </span><span class="green">|| (</span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">id </span><span class="green">!= </span><span class="blue">$id</span><span class="green">)
            );
            
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">parentId </span><span class="green">= </span><span class="blue">$id</span><span class="green">;
            
            return </span><span class="blue">$this</span><span class="green">;
        }
        
        public function </span><span class="blue">getThreadId</span><span class="green">()
        {
            return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">threadId</span><span class="green">;
        }
        
        public function </span><span class="blue">setThreadId</span><span class="green">(</span><span class="blue">$id</span><span class="green">)
        {
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">threadId </span><span class="green">= </span><span class="blue">$id</span><span class="green">;
            
            return </span><span class="blue">$this</span><span class="green">;
        }
        
        public function </span><span class="blue">getPerson</span><span class="green">()
        {
            return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">person</span><span class="green">;
        }
        
        public function </span><span class="blue">setPerson</span><span class="green">(</span><span class="blue">Person $person</span><span class="green">)
        {
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">person </span><span class="green">= </span><span class="blue">$person</span><span class="green">;
            
            return </span><span class="blue">$this</span><span class="green">;
        }
        
        public function </span><span class="blue">getCreated</span><span class="green">()
        {
            return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">created</span><span class="green">;
        }
        
        public function </span><span class="blue">setCreated</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FTimestamp.class.php&rev=0&sc=0">Timestamp</a> $created</span><span class="green">)
        {
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">created </span><span class="green">= </span><span class="blue">$created</span><span class="green">;
            
            return </span><span class="blue">$this</span><span class="green">;
        }
        
        public function </span><span class="blue">getContent</span><span class="green">()
        {
            return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">content</span><span class="green">;
        }
        
        public function </span><span class="blue">setContent</span><span class="green">(</span><span class="blue">$blaBlaBla</span><span class="green">)
        {
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">content </span><span class="green">= </span><span class="blue">$blaBlaBla</span><span class="green">;
            
            return </span><span class="blue">$this</span><span class="green">;
        }
        
        public function </span><span class="blue">getChildsCount</span><span class="green">()
        {
            return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">count</span><span class="green">;
        }
        
        public function </span><span class="blue">setChildsCount</span><span class="green">(</span><span class="blue">$count</span><span class="green">)
        {
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">count </span><span class="green">= </span><span class="blue">$count</span><span class="green">;
            
            return </span><span class="blue">$this</span><span class="green">;
        }
    }</span>
</pre>

<p>let's simplify our life by DAO-wrapper:</p>

<pre>
    <span class="green">final class </span><span class="blue">DAO
    </span><span class="green">{
        public static function </span><span class="blue">forum</span><span class="green">()
        {
            return </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FSingletone.class.php&rev=0&sc=0">Singletone</a></span><span class="green">::</span><span class="blue">getInstance</span><span class="green">(</span><span class="red">'ForumDAO'</span><span class="green">);
        }
        
        public static function </span><span class="blue">message</span><span class="green">()
        {
            return </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FSingletone.class.php&rev=0&sc=0">Singletone</a></span><span class="green">::</span><span class="blue">getInstance</span><span class="green">(</span><span class="red">'MessageDAO'</span><span class="green">);
        }
        
        public static function </span><span class="blue">person</span><span class="green">()
        {
            return </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FSingletone.class.php&rev=0&sc=0">Singletone</a></span><span class="green">::</span><span class="blue">getInstance</span><span class="green">(</span><span class="red">'PersonDAO'</span><span class="green">);
        }
    }</span>
</pre>

<p>ok, 1 of 3 DAOs:</p>

<pre>
    <span class="green">final class </span><span class="blue">PersonDAO </span><span class="green">extends </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FDAOs%2FMappedStorableDAO.class.php&rev=0&sc=0">MappedStorableDAO</a>
    </span><span class="green">{
        </span><span class="orange">// quite obvious mapping
        </span><span class="green">protected </span><span class="blue">$mapping </span><span class="green">= array(
            </span><span class="red">'id'                  </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'nickname'            </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'password'            </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'mail'                </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'created'             </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'modified'            </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'lastLogin'           </span><span class="green">=&gt; </span><span class="red">'last_login'
        </span><span class="green">);
        
        public function </span><span class="blue">getTable</span><span class="green">()
        {
            return </span><span class="red">'person'</span><span class="green">;
        }
        
        public function </span><span class="blue">getSequence</span><span class="green">()
        {
            return </span><span class="red">'person_id'</span><span class="green">;
        }
        
        public function </span><span class="blue">getObjectName</span><span class="green">()
        {
            return </span><span class="red">'Person'</span><span class="green">;
        }

        public function </span><span class="blue">logIn</span><span class="green">(</span><span class="blue">$userName</span><span class="green">, </span><span class="blue">$passWord</span><span class="green">)
        {
            </span><span class="blue">$person </span><span class="green">=
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getByLogic</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">expAnd</span><span class="green">(
                        </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">eq</span><span class="green">(</span><span class="red">'nickname'</span><span class="green">, </span><span class="blue">$userName</span><span class="green">),
                        </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">eq</span><span class="green">(</span><span class="red">'password'</span><span class="green">, </span><span class="blue">$passWord</span><span class="green">)
                    )
                );
                
            return
                </span><span class="orange">// sync last login time
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">save</span><span class="green">(
                    </span><span class="blue">$person</span><span class="green">-&gt;</span><span class="blue">setLastLogin</span><span class="green">(
                        new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FTimestamp.class.php&rev=0&sc=0">Timestamp</a></span><span class="green">(</span><span class="blue">time</span><span class="green">())
                    )
                );
        }

        public function </span><span class="blue">makeObject</span><span class="green">(&amp;</span><span class="blue">$array</span><span class="green">, </span><span class="blue">$prefix </span><span class="green">= </span><span class="blue">null</span><span class="green">)
        {
            </span><span class="green">return</span>
                <span class="blue">Person</span><span class="green">::</span><span class="blue">create</span><span class="green">()-&gt;
                </span><span class="blue">setId</span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'id'</span><span class="green">])-&gt;
                </span><span class="blue">setNickname</span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'nickname'</span><span class="green">])-&gt;
                </span><span class="blue">setPassword</span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'password'</span><span class="green">])-&gt;
                </span><span class="blue">setMail</span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'mail'</span><span class="green">])-&gt;
                </span><span class="blue">setCreated</span><span class="green">(new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FTimestamp.class.php&rev=0&sc=0">Timestamp</a></span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'created'</span><span class="green">]))-&gt;
                </span><span class="blue">setModified</span><span class="green">(new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FTimestamp.class.php&rev=0&sc=0">Timestamp</a></span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'modified'</span><span class="green">]))-&gt;
                </span><span class="blue">setLastLogin</span><span class="green">(new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FTimestamp.class.php&rev=0&sc=0">Timestamp</a></span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'last_login'</span><span class="green">]));
        }
        
        public function </span><span class="blue">setQueryFields</span><span class="green">(
            </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FInsertOrUpdateQuery.class.php&rev=0&sc=0">InsertOrUpdateQuery</a> $query</span><span class="green">, </span><span class="blue">Person $person
        </span><span class="green">)
        {
            </span><span class="blue">$now </span><span class="green">= new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FTimestamp.class.php&rev=0&sc=0">Timestamp</a></span><span class="green">(</span><span class="blue">time</span><span class="green">());

            </span><span class="orange">// don't forget about time upon creation
            </span><span class="green">if (</span><span class="blue">$query </span><span class="green">instanceof </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FInsertQuery.class.php&rev=0&sc=0">InsertQuery</a></span><span class="green">)
                </span><span class="blue">$query</span><span class="green">-&gt;</span><span class="blue">set</span><span class="green">(
                    </span><span class="red">'created'</span><span class="green">,
                    </span><span class="blue">$person</span><span class="green">-&gt;</span><span class="blue">setCreated</span><span class="green">(
                        </span><span class="blue">$now
                    </span><span class="green">)-&gt;
                    </span><span class="blue">getCreated</span><span class="green">()-&gt;</span><span class="blue">toString</span><span class="green">()
                );
            
            return
                </span><span class="blue">$query</span><span class="green">-&gt;
                    </span><span class="orange">// don't forget about time upon any modification too
                    </span><span class="blue">set</span><span class="green">(
                        </span><span class="red">'modified'</span><span class="green">,
                        </span><span class="blue">$person</span><span class="green">-&gt;</span><span class="blue">setModified</span><span class="green">(</span><span class="blue">$now</span><span class="green">)-&gt;
                            </span><span class="blue">getModified</span><span class="green">()-&gt;</span><span class="blue">toString</span><span class="green">()
                    )-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'id'</span><span class="green">, </span><span class="blue">$person</span><span class="green">-&gt;</span><span class="blue">getId</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'nickname'</span><span class="green">, </span><span class="blue">$person</span><span class="green">-&gt;</span><span class="blue">getNickname</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'password'</span><span class="green">, </span><span class="blue">$person</span><span class="green">-&gt;</span><span class="blue">getPassword</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'mail'</span><span class="green">, </span><span class="blue">$person</span><span class="green">-&gt;</span><span class="blue">getMail</span><span class="green">());
        }
    }</span>
</pre>

<p>2 of 3:</p>

<pre>
    <span class="green">final class </span><span class="blue">ForumDAO </span><span class="green">extends </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FDAOs%2FMappedStorableDAO.class.php&rev=0&sc=0">MappedStorableDAO</a>
    </span><span class="green">{
        protected </span><span class="blue">$mapping </span><span class="green">= array(
            </span><span class="red">'id'             </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'name'           </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'description'    </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'created'        </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'modified'       </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'messageCount'   </span><span class="green">=&gt; </span><span class="red">'message_count'
        </span><span class="green">);
        
        public function </span><span class="blue">getTable</span><span class="green">()
        {
            return </span><span class="red">'forum'</span><span class="green">;
        }
        
        public function </span><span class="blue">getSequence</span><span class="green">()
        {
            return </span><span class="red">'forum_id'</span><span class="green">;
        }
        
        public function </span><span class="blue">getObjectName</span><span class="green">()
        {
            return </span><span class="red">'Forum'</span><span class="green">;
        }
        
        </span><span class="orange">// allow remote uncaching
        </span><span class="green">public function </span><span class="blue">uncacheById</span><span class="green">(</span><span class="blue">$id</span><span class="green">)
        {
            return </span><span class="blue">parent</span><span class="green">::</span><span class="blue">uncacheById</span><span class="green">(</span><span class="blue">$id</span><span class="green">);
        }
        
        public function </span><span class="blue">makeObject</span><span class="green">(&amp;</span><span class="blue">$array</span><span class="green">, </span><span class="blue">$prefix </span><span class="green">= </span><span class="blue">null</span><span class="green">)
        {
            return
                </span><span class="blue">Forum</span><span class="green">::</span><span class="blue">create</span><span class="green">()-&gt;
                </span><span class="blue">setId</span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'id'</span><span class="green">])-&gt;
                </span><span class="blue">setName</span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'name'</span><span class="green">])-&gt;
                </span><span class="blue">setCreated</span><span class="green">(new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FTimestamp.class.php&rev=0&sc=0">Timestamp</a></span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'created'</span><span class="green">]))-&gt;
                </span><span class="blue">setModified</span><span class="green">(new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FTimestamp.class.php&rev=0&sc=0">Timestamp</a></span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'modified'</span><span class="green">]))-&gt;
                </span><span class="blue">setMessageCount</span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'message_count'</span><span class="green">])-&gt;
                </span><span class="orange">// optional
                </span><span class="blue">setDescription</span><span class="green">(
                    isset(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'description'</span><span class="green">])
                        ? </span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'description'</span><span class="green">]
                        : </span><span class="blue">null
                </span><span class="green">);
        }
        
        public function </span><span class="blue">setQueryFields</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FInsertOrUpdateQuery.class.php&rev=0&sc=0">InsertOrUpdateQuery</a> $query</span><span class="green">, </span><span class="blue">Forum $forum</span><span class="green">)
        {
            </span><span class="blue">$now </span><span class="green">= new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FTimestamp.class.php&rev=0&sc=0">Timestamp</a></span><span class="green">(</span><span class="blue">time</span><span class="green">());
            
            if (</span><span class="blue">$query </span><span class="green">instanceof </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FInsertQuery.class.php&rev=0&sc=0">InsertQuery</a></span><span class="green">) {
                </span><span class="blue">$query</span><span class="green">-&gt;</span><span class="blue">set</span><span class="green">(
                    </span><span class="red">'created'</span><span class="green">,
                    </span><span class="blue">$forum</span><span class="green">-&gt;</span><span class="blue">setCreated</span><span class="green">(</span><span class="blue">$now</span><span class="green">)-&gt;
                        </span><span class="blue">getCreated</span><span class="green">()-&gt;</span><span class="blue">toString</span><span class="green">()
                );
                
                </span><span class="blue">$forum</span><span class="green">-&gt;</span><span class="blue">setMessageCount</span><span class="green">(</span><span class="blue">0</span><span class="green">);
            }
            
            return
                </span><span class="blue">$query</span><span class="green">-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'id'</span><span class="green">, </span><span class="blue">$forum</span><span class="green">-&gt;</span><span class="blue">getId</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'name'</span><span class="green">, </span><span class="blue">$forum</span><span class="green">-&gt;</span><span class="blue">getName</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'description'</span><span class="green">, </span><span class="blue">$forum</span><span class="green">-&gt;</span><span class="blue">getDescription</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'message_count'</span><span class="green">, </span><span class="blue">$forum</span><span class="green">-&gt;</span><span class="blue">getMessageCount</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(
                        </span><span class="red">'modified'</span><span class="green">,
                        </span><span class="blue">$forum</span><span class="green">-&gt;</span><span class="blue">setModified</span><span class="green">(</span><span class="blue">$now</span><span class="green">)-&gt;
                            </span><span class="blue">getModified</span><span class="green">()-&gt;</span><span class="blue">toString</span><span class="green">()
                    );
        }
    }</span>
</pre>

<p>final and most interesting:</p>

<pre>
    <span class="green">final class </span><span class="blue">MessageDAO </span><span class="green">extends </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FDAOs%2FMappedStorableDAO.class.php&rev=0&sc=0">MappedStorableDAO</a>
    </span><span class="green">{
        protected </span><span class="blue">$mapping </span><span class="green">= array(
            </span><span class="red">'id'          </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'name'        </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'forumId'     </span><span class="green">=&gt; </span><span class="red">'forum_id'</span><span class="green">,
            </span><span class="red">'personId'    </span><span class="green">=&gt; </span><span class="red">'person_id'</span><span class="green">,
            </span><span class="red">'parentId'    </span><span class="green">=&gt; </span><span class="red">'parent_id'</span><span class="green">,
            </span><span class="red">'threadId'    </span><span class="green">=&gt; </span><span class="red">'thread_id'</span><span class="green">,
            </span><span class="red">'created'     </span><span class="green">=&gt; </span><span class="blue">null
            </span><span class="orange">// 'content' hided from default fields/mapping
        </span><span class="green">);
        
        public function </span><span class="blue">getTable</span><span class="green">()
        {
            return </span><span class="red">'message'</span><span class="green">;
        }
        
        public function </span><span class="blue">getBodyTable</span><span class="green">()
        {
            return </span><span class="red">'message_body'</span><span class="green">;
        }
        
        public function </span><span class="blue">getObjectName</span><span class="green">()
        {
            return </span><span class="red">'Message'</span><span class="green">;
        }
        
        </span><span class="orange">// wrappers
        </span><span class="green">public function </span><span class="blue">getById</span><span class="green">(</span><span class="blue">$id</span><span class="green">, </span><span class="blue">$full </span><span class="green">= </span><span class="blue">false</span><span class="green">)
        {
            </span><span class="blue">$query </span><span class="green">=
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">makeSelectHead</span><span class="green">()-&gt;
                </span><span class="blue">where</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">eq</span><span class="green">(
                        </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FDBField.class.php&rev=0&sc=0">DBField</a></span><span class="green">::</span><span class="blue">create</span><span class="green">(</span><span class="red">'id'</span><span class="green">, </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getTable</span><span class="green">()),
                        </span><span class="blue">$id
                    </span><span class="green">)
                );
            
            if (</span><span class="blue">$full</span><span class="green">)
                </span><span class="blue">$query</span><span class="green">-&gt;</span><span class="blue">get</span><span class="green">(</span><span class="red">'content'</span><span class="green">);
            
            return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getByQuery</span><span class="green">(</span><span class="blue">$query</span><span class="green">);
        }
        
        public function </span><span class="blue">getList</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FDAOs%2FObjectQuery.class.php&rev=0&sc=0">ObjectQuery</a> $oq</span><span class="green">, </span><span class="blue">$full </span><span class="green">= </span><span class="blue">false</span><span class="green">)
        {
            </span><span class="blue">$query </span><span class="green">= </span><span class="blue">$oq</span><span class="green">-&gt;</span><span class="blue">toSelectQuery</span><span class="green">(</span><span class="blue">$this</span><span class="green">);
            
            if (</span><span class="blue">$full</span><span class="green">)
                </span><span class="blue">$query</span><span class="green">-&gt;</span><span class="blue">get</span><span class="green">(</span><span class="red">'content'</span><span class="green">);
            
            return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getListByQuery</span><span class="green">(</span><span class="blue">$query</span><span class="green">);
        }
        
        public function </span><span class="blue">makeObject</span><span class="green">(&amp;</span><span class="blue">$array</span><span class="green">, </span><span class="blue">$prefix </span><span class="green">= </span><span class="blue">null</span><span class="green">)
        {
            return
                </span><span class="blue">Message</span><span class="green">::</span><span class="blue">create</span><span class="green">()-&gt;
                </span><span class="blue">setId</span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'id'</span><span class="green">])-&gt;
                </span><span class="blue">setName</span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'name'</span><span class="green">])-&gt;
                </span><span class="blue">setCreated</span><span class="green">(new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FTimestamp.class.php&rev=0&sc=0">Timestamp</a></span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'created'</span><span class="green">]))-&gt;
                </span><span class="blue">setForumId</span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'forum_id'</span><span class="green">])-&gt;
                </span><span class="blue">setPerson</span><span class="green">(
                    </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">person</span><span class="green">()-&gt;</span><span class="blue">getById</span><span class="green">(
                        </span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'person_id'</span><span class="green">]
                    )
                )-&gt;
                </span><span class="blue">setContent</span><span class="green">(
                    isset(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'content'</span><span class="green">])
                        ? </span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'content'</span><span class="green">]
                        : </span><span class="blue">null
                </span><span class="green">)-&gt;
                </span><span class="orange">// null when top level
                </span><span class="blue">setParentId</span><span class="green">(
                    isset(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'parent_id'</span><span class="green">])
                        ? </span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'parent_id'</span><span class="green">]
                        : </span><span class="blue">null
                </span><span class="green">)-&gt;
                </span><span class="blue">setThreadId</span><span class="green">(
                    isset(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'thread_id'</span><span class="green">])
                        ? </span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'thread_id'</span><span class="green">]
                        : </span><span class="blue">null
                </span><span class="green">)-&gt;
                </span><span class="blue">setChildsCount</span><span class="green">(
                    isset(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'count'</span><span class="green">])
                        ? </span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'count'</span><span class="green">]
                        : </span><span class="blue">null
                </span><span class="green">);
        }
        
        public function </span><span class="blue">setQueryFields</span><span class="green">(
            </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FInsertOrUpdateQuery.class.php&rev=0&sc=0">InsertOrUpdateQuery</a> $query</span><span class="green">, </span><span class="blue">Message $message
        </span><span class="green">)
        {
            if (</span><span class="blue">$query </span><span class="green">instanceof </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FInsertQuery.class.php&rev=0&sc=0">InsertQuery</a></span><span class="green">)
                </span><span class="blue">$query</span><span class="green">-&gt;</span><span class="blue">set</span><span class="green">(
                    </span><span class="red">'created'</span><span class="green">,
                    </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">setCreated</span><span class="green">(new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FTimestamp.class.php&rev=0&sc=0">Timestamp</a></span><span class="green">(</span><span class="blue">time</span><span class="green">()))-&gt;
                        </span><span class="blue">getCreated</span><span class="green">()-&gt;</span><span class="blue">toString</span><span class="green">()
                );
            
            return
                </span><span class="blue">$query</span><span class="green">-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'id'</span><span class="green">,             </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getId</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'name'</span><span class="green">,           </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getName</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'content'</span><span class="green">,        </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getContent</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'forum_id'</span><span class="green">,       </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getForumId</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'person_id'</span><span class="green">,      </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getPerson</span><span class="green">()-&gt;</span><span class="blue">getId</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'parent_id'</span><span class="green">,      </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getParentId</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'thread_id'</span><span class="green">,      </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getThreadId</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'created'</span><span class="green">,        </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getCreated</span><span class="green">()-&gt;</span><span class="blue">toString</span><span class="green">());
        }
        
        public function </span><span class="blue">getThreadList</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FDAOs%2FObjectQuery.class.php&rev=0&sc=0">ObjectQuery</a> $oq</span><span class="green">)
        {
            return
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getQueryResult</span><span class="green">(
                    </span><span class="blue">$oq</span><span class="green">-&gt;</span><span class="blue">toSelectQuery</span><span class="green">(</span><span class="blue">$this</span><span class="green">)-&gt;
                    </span><span class="blue">get</span><span class="green">(
                        </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FOSQL.class.php&rev=0&sc=0">OSQL</a></span><span class="green">::</span><span class="blue">select</span><span class="green">()-&gt;</span><span class="blue">from</span><span class="green">(</span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getTable</span><span class="green">(), </span><span class="red">'sub'</span><span class="green">)-&gt;
                        </span><span class="blue">get</span><span class="green">(
                            </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">sub</span><span class="green">(
                                </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FSQLFunction.class.php&rev=0&sc=0">SQLFunction</a></span><span class="green">::</span><span class="blue">create</span><span class="green">(</span><span class="red">'count'</span><span class="green">, </span><span class="red">'id'</span><span class="green">),
                                new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FDBValue.class.php&rev=0&sc=0">DBValue</a></span><span class="green">(</span><span class="blue">1</span><span class="green">)
                            )
                        )-&gt;
                        </span><span class="blue">where</span><span class="green">(
                            </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">eq</span><span class="green">(
                                new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FDBField.class.php&rev=0&sc=0">DBField</a></span><span class="green">(</span><span class="red">'thread_id'</span><span class="green">, </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getTable</span><span class="green">()),
                                new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FDBField.class.php&rev=0&sc=0">DBField</a></span><span class="green">(</span><span class="red">'thread_id'</span><span class="green">, </span><span class="red">'sub'</span><span class="green">)
                            )
                        )-&gt;
                        </span><span class="blue">setName</span><span class="green">(</span><span class="red">'count'</span><span class="green">)
                    )-&gt;
                    </span><span class="blue">andWhere</span><span class="green">(
                        </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">isNull</span><span class="green">(</span><span class="red">'parent_id'</span><span class="green">)
                    )
                );
        }
        
        protected function </span><span class="blue">inject</span><span class="green">(
            </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FInsertOrUpdateQuery.class.php&rev=0&sc=0">InsertOrUpdateQuery</a> $query</span><span class="green">, </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FIdentifiable.class.php&rev=0&sc=0">Identifiable</a> $message
        </span><span class="green">)
        {
            </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FAssert.class.php&rev=0&sc=0">Assert</a></span><span class="green">::</span><span class="blue">isTrue</span><span class="green">(</span><span class="blue">$message </span><span class="green">instanceof </span><span class="blue">Message</span><span class="green">); </span><span class="orange">// paranoia
            
            // we should update 'modified' and 'message_count' there
            </span><span class="blue">$forumQuery </span><span class="green">= </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FOSQL.class.php&rev=0&sc=0">OSQL</a></span><span class="green">::</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FUpdateQuery.class.php&rev=0&sc=0">update</a></span><span class="green">(</span><span class="blue">DAO</span><span class="green">::</span><span class="blue">forum</span><span class="green">()-&gt;</span><span class="blue">getTable</span><span class="green">());
            
            if (</span><span class="blue">$query </span><span class="green">instanceof </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FInsertQuery.class.php&rev=0&sc=0">InsertQuery</a></span><span class="green">) {
                if (</span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getThreadId</span><span class="green">() === </span><span class="blue">null</span><span class="green">)
                    </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">setThreadId</span><span class="green">(
                        </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getId</span><span class="green">()
                    );

                </span><span class="orange">// increase message counter upon message addition
                </span><span class="blue">$forumQuery</span><span class="green">-&gt;
                    </span><span class="blue">set</span><span class="green">(
                        </span><span class="red">'message_count'</span><span class="green">,
                        </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">add</span><span class="green">(
                            new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FDBField.class.php&rev=0&sc=0">DBField</a></span><span class="green">(</span><span class="red">'message_count'</span><span class="green">),
                            new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FDBValue.class.php&rev=0&sc=0">DBValue</a></span><span class="green">(</span><span class="blue">1</span><span class="green">)
                        )
                    );
            }
            
            </span><span class="orange">// modification time should be set
            // on every message-realted action
            </span><span class="blue">$forumQuery</span><span class="green">-&gt;
                </span><span class="blue">set</span><span class="green">(</span><span class="red">'modified'</span><span class="green">, </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FSQLFunction.class.php&rev=0&sc=0">SQLFunction</a></span><span class="green">::</span><span class="blue">create</span><span class="green">(</span><span class="red">'now'</span><span class="green">));

            </span><span class="orange">// go
            </span><span class="blue">Transaction</span><span class="green">::</span><span class="blue">immediate</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FDB%2FDBFactory.class.php&rev=0&sc=0">DBFactory</a></span><span class="green">::</span><span class="blue">getDefaultInstance</span><span class="green">())-&gt;
            </span><span class="blue">add</span><span class="green">(
                </span><span class="orange">// main query
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">setQueryFields</span><span class="green">(
                    </span><span class="blue">$query</span><span class="green">-&gt;</span><span class="blue">setTable</span><span class="green">(</span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getTable</span><span class="green">()),
                    </span><span class="blue">$message
                </span><span class="green">)
            )-&gt;
            </span><span class="blue">add</span><span class="green">(
                </span><span class="orange">// forum' update query
                </span><span class="blue">$forumQuery
            </span><span class="green">)-&gt;
            </span><span class="blue">flush</span><span class="green">();
            
            </span><span class="orange">// drop all message-related lists from cache
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">dropLists</span><span class="green">();
            
            </span><span class="orange">// uncache message's forum object
            </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">forum</span><span class="green">()-&gt;</span><span class="blue">uncacheById</span><span class="green">(</span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getForumId</span><span class="green">());
            
            </span><span class="orange">// uncache message, if any
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">uncacheById</span><span class="green">(</span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getId</span><span class="green">());
            
            return </span><span class="blue">$message</span><span class="green">;
        }
    }</span>
</pre>

<p>so here goes our business logic (all view-templates are omitted), list of available forums:</p>

<pre>
    <span class="green">final class </span><span class="blue">forumList </span><span class="green">extends </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FModule%2FBaseModule.class.php&rev=0&sc=0">BaseModule</a>
    </span><span class="green">{
        protected </span><span class="blue">$plainList </span><span class="green">= array();
        
        public function </span><span class="blue">process</span><span class="green">()
        {
            try {
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">forumList </span><span class="green">= </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">forum</span><span class="green">()-&gt;</span><span class="blue">getPlainList</span><span class="green">();
            } catch (</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FExceptions%2FObjectNotFoundException.class.php&rev=0&sc=0">ObjectNotFoundException</a> $e</span><span class="green">) {
                </span><span class="orange">// no forums created yet
            </span><span class="green">}
            
            return </span><span class="blue">$this</span><span class="green">;
        }
        
        </span><span class="orange">/* don't forget to include your favorite template at dump() */
    </span><span class="green">}</span>
</pre>

<p>current forum threads list with ability to add new threads:</p>

<pre>
    <span class="green">final class </span><span class="blue">threadList </span><span class="green">extends </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FModule%2FFormedModule.class.php&rev=0&sc=0">FormedModule</a>
    </span><span class="green">{
        const </span><span class="blue">PER_PAGE </span><span class="green">= </span><span class="blue">50</span><span class="green">;
        
        protected </span><span class="blue">$forum        </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        protected </span><span class="blue">$threadList   </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        
        public function </span><span class="blue">init</span><span class="green">()
        {
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">form</span><span class="green">-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue">boolean</span><span class="green">(</span><span class="red">'post'</span><span class="green">)
                )-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitiveInteger.class.php&rev=0&sc=0">integer</a></span><span class="green">(</span><span class="red">'forumId'</span><span class="green">)-&gt;</span><span class="blue">required</span><span class="green">()
                )-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitiveInteger.class.php&rev=0&sc=0">integer</a></span><span class="green">(</span><span class="red">'page'</span><span class="green">)-&gt;</span><span class="blue">setDefault</span><span class="green">(</span><span class="blue">1</span><span class="green">)
                )-&gt;
                </span><span class="blue">import</span><span class="green">(</span><span class="blue">$_GET</span><span class="green">);

            </span><span class="orange">// forum's id is missing or invalid
            </span><span class="green">if (</span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">form</span><span class="green">-&gt;</span><span class="blue">getErrors</span><span class="green">())
                return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">blowOut</span><span class="green">();

            </span><span class="orange">// in case we're awaiting new message arrival
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">form</span><span class="green">-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitiveString.class.php&rev=0&sc=0">string</a></span><span class="green">(</span><span class="red">'name'</span><span class="green">)-&gt;</span><span class="blue">setMax</span><span class="green">(</span><span class="blue">255</span><span class="green">)-&gt;</span><span class="blue">required</span><span class="green">()-&gt;
                    </span><span class="blue">addImportFilter</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FFilter.class.php&rev=0&sc=0">Filter</a></span><span class="green">::</span><span class="blue">textImport</span><span class="green">())-&gt;
                    </span><span class="blue">addDisplayFilter</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FFilter.class.php&rev=0&sc=0">Filter</a></span><span class="green">::</span><span class="blue">htmlSpecialChars</span><span class="green">())
                )-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitiveString.class.php&rev=0&sc=0">string</a></span><span class="green">(</span><span class="red">'content'</span><span class="green">)-&gt;</span><span class="blue">setMax</span><span class="green">(</span><span class="blue">40960</span><span class="green">)-&gt;</span><span class="blue">required</span><span class="green">()-&gt; </span><span class="orange">// ~40Kb
                    </span><span class="blue">addImportFilter</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FFilter.class.php&rev=0&sc=0">Filter</a></span><span class="green">::</span><span class="blue">textImport</span><span class="green">())-&gt;
                    </span><span class="blue">addDisplayFilter</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FFilter.class.php&rev=0&sc=0">Filter</a></span><span class="green">::</span><span class="blue">htmlSpecialChars</span><span class="green">())
                )-&gt;
                </span><span class="blue">importMore</span><span class="green">(</span><span class="blue">$_POST</span><span class="green">);
            
            return </span><span class="blue">$this</span><span class="green">;
        }
        
        public function </span><span class="blue">process</span><span class="green">()
        {
            </span><span class="blue">$form </span><span class="green">= </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">form</span><span class="green">;
            
            try {
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">forum </span><span class="green">= </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">forum</span><span class="green">()-&gt;</span><span class="blue">getById</span><span class="green">(
                    </span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getValue</span><span class="green">(</span><span class="red">'forumId'</span><span class="green">)
                );
            } catch (</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FExceptions%2FObjectNotFoundException.class.php&rev=0&sc=0">ObjectNotFoundException</a> $e</span><span class="green">) {
                </span><span class="orange">// forum with such id does not exist
                </span><span class="green">return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">blowOut</span><span class="green">(</span><span class="red">'forumList'</span><span class="green">);
            }

            </span><span class="orange">// check POST-trigger
            </span><span class="green">if (</span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getValue</span><span class="green">(</span><span class="red">'post'</span><span class="green">)) {
                
                </span><span class="orange">// imaginary class to check user's permissions to post
                </span><span class="green">if (!</span><span class="blue">SecurityManager</span><span class="green">::</span><span class="blue">isLoggedIn</span><span class="green">())
                    return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">blowOut</span><span class="green">();
                
                </span><span class="orange">// if there are any errors,
                // user should correct them first
                </span><span class="green">if (</span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getErrors</span><span class="green">())
                    return </span><span class="blue">$this</span><span class="green">;
                
                </span><span class="orange">// ok, let's build new object
                </span><span class="blue">$message </span><span class="green">=
                    </span><span class="blue">Message</span><span class="green">::</span><span class="blue">create</span><span class="green">()-&gt;
                    </span><span class="blue">setPerson</span><span class="green">(
                        </span><span class="blue">SecurityManager</span><span class="green">::</span><span class="blue">getUser</span><span class="green">()
                    )-&gt;
                    </span><span class="blue">setForumId</span><span class="green">(
                        </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">forum</span><span class="green">-&gt;</span><span class="blue">getId</span><span class="green">()
                    )-&gt;
                    </span><span class="orange">// parent should be null
                    // thread will be set at DAO
                    </span><span class="blue">setName</span><span class="green">(
                        </span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getValue</span><span class="green">(</span><span class="red">'name'</span><span class="green">)
                    )-&gt;
                    </span><span class="blue">setContent</span><span class="green">(
                        </span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getValue</span><span class="green">(</span><span class="red">'content'</span><span class="green">)
                    );
                
                </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">message</span><span class="green">()-&gt;</span><span class="blue">add</span><span class="green">(</span><span class="blue">$message</span><span class="green">);
                
                </span><span class="orange">// go back to thread's list
                </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FUtils%2FHeaderUtils.class.php&rev=0&sc=0">HeaderUtils</a></span><span class="green">::</span><span class="blue">redirect</span><span class="green">(
                    </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">setParameters</span><span class="green">(
                        array(
                            </span><span class="red">'forumId' </span><span class="green">=&gt; </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">forum</span><span class="green">-&gt;</span><span class="blue">getId</span><span class="green">()
                        )
                    )
                );
                
                return </span><span class="blue">$this</span><span class="green">;
                
            } else
                </span><span class="orange">// there was no POST-trigger,
                // so assume, there were no input
                </span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">dropAllErrors</span><span class="green">();

            try {
                </span><span class="orange">// let's get this forum's threads list
                // sorted by creation time
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">threadList </span><span class="green">=
                    </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">message</span><span class="green">()-&gt;</span><span class="blue">getThreadList</span><span class="green">(
                        </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FDAOs%2FObjectQuery.class.php&rev=0&sc=0">ObjectQuery</a></span><span class="green">::</span><span class="blue">create</span><span class="green">()-&gt;
                        </span><span class="blue">addLogic</span><span class="green">(
                            </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">eqId</span><span class="green">(</span><span class="red">'forumId'</span><span class="green">, </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">forum</span><span class="green">)
                        )-&gt;
                        </span><span class="blue">sort</span><span class="green">(</span><span class="red">'created'</span><span class="green">)-&gt;</span><span class="blue">desc</span><span class="green">()
                    );
            } catch (</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FExceptions%2FObjectNotFoundException.class.php&rev=0&sc=0">ObjectNotFoundException</a> $e</span><span class="green">) {
                </span><span class="orange">// newly created, probably
            </span><span class="green">}
            
            return </span><span class="blue">$this</span><span class="green">;
        }
        
        </span><span class="orange">/* don't forget to include your favorite template at dump() */
    </span><span class="green">}</span>
</pre>

<p>single thread view with ability to {un,}fold messages and to post replies:</p>

<pre>
    <span class="green">final class </span><span class="blue">threadView </span><span class="green">extends </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FModule%2FFormedModule.class.php&rev=0&sc=0">FormedModule</a>
    </span><span class="green">{
        </span><span class="orange">// current forum
        </span><span class="green">protected </span><span class="blue">$forum          </span><span class="green">= </span><span class="blue">null</span><span class="green">;

        </span><span class="orange">// current viewed message
        </span><span class="green">protected </span><span class="blue">$message        </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        
        </span><span class="orange">// all messages list
        </span><span class="green">protected </span><span class="blue">$messageList    </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        
        public function </span><span class="blue">init</span><span class="green">()
        {
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">form</span><span class="green">-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitiveInteger.class.php&rev=0&sc=0">integer</a></span><span class="green">(</span><span class="red">'id'</span><span class="green">)-&gt;</span><span class="blue">required</span><span class="green">()
                )-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue">boolean</span><span class="green">(</span><span class="red">'post'</span><span class="green">)
                )-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue">boolean</span><span class="green">(</span><span class="red">'unfold'</span><span class="green">)-&gt;</span><span class="blue">setDefault</span><span class="green">(</span><span class="blue">false</span><span class="green">)
                )-&gt;
                </span><span class="blue">import</span><span class="green">(</span><span class="blue">$_GET</span><span class="green">);
            
            </span><span class="orange">// same logic as in threadList module
            </span><span class="green">if (</span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">form</span><span class="green">-&gt;</span><span class="blue">getErrors</span><span class="green">())
                return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">blowOut</span><span class="green">(</span><span class="red">'forumList'</span><span class="green">);

            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">form</span><span class="green">-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitiveString.class.php&rev=0&sc=0">string</a></span><span class="green">(</span><span class="red">'name'</span><span class="green">)-&gt;</span><span class="blue">setMax</span><span class="green">(</span><span class="blue">255</span><span class="green">)-&gt;</span><span class="blue">required</span><span class="green">()-&gt;
                    </span><span class="blue">addImportFilter</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FFilter.class.php&rev=0&sc=0">Filter</a></span><span class="green">::</span><span class="blue">textImport</span><span class="green">())-&gt;
                    </span><span class="blue">addDisplayFilter</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FFilter.class.php&rev=0&sc=0">Filter</a></span><span class="green">::</span><span class="blue">htmlSpecialChars</span><span class="green">())
                )-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitiveString.class.php&rev=0&sc=0">string</a></span><span class="green">(</span><span class="red">'content'</span><span class="green">)-&gt;</span><span class="blue">setMax</span><span class="green">(</span><span class="blue">40960</span><span class="green">)-&gt;</span><span class="blue">required</span><span class="green">()-&gt; </span><span class="orange">// ~40Kb
                    </span><span class="blue">addImportFilter</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FFilter.class.php&rev=0&sc=0">Filter</a></span><span class="green">::</span><span class="blue">textImport</span><span class="green">())-&gt;
                    </span><span class="blue">addDisplayFilter</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FFilter.class.php&rev=0&sc=0">Filter</a></span><span class="green">::</span><span class="blue">htmlSpecialChars</span><span class="green">())
                )-&gt;
                </span><span class="blue">importMore</span><span class="green">(</span><span class="blue">$_POST</span><span class="green">);
            
            return </span><span class="blue">$this</span><span class="green">;
        }
        
        public function </span><span class="blue">process</span><span class="green">()
        {
            </span><span class="blue">$form </span><span class="green">= </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">form</span><span class="green">;
            
            try {
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">message </span><span class="green">= </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">message</span><span class="green">()-&gt;</span><span class="blue">getById</span><span class="green">(
                    </span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getValue</span><span class="green">(</span><span class="red">'id'</span><span class="green">),
                    </span><span class="orange">// get content, if user requested so
                    </span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getActualValue</span><span class="green">(</span><span class="red">'unfold'</span><span class="green">)
                );
            } catch (</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FExceptions%2FObjectNotFoundException.class.php&rev=0&sc=0">ObjectNotFoundException</a> $e</span><span class="green">) {
                </span><span class="orange">// there is no such message
                </span><span class="green">return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">blowOut</span><span class="green">(</span><span class="red">'forumList'</span><span class="green">);
            }
            
            </span><span class="orange">// POST-trigger
            </span><span class="green">if (</span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getValue</span><span class="green">(</span><span class="red">'post'</span><span class="green">)) {

                </span><span class="orange">// imaginary class again
                </span><span class="green">if (!</span><span class="blue">SecurityManager</span><span class="green">::</span><span class="blue">isLoggedIn</span><span class="green">())
                    return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">blowOut</span><span class="green">();
                
                if (!</span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getErrors</span><span class="green">()) {
                
                    </span><span class="orange">// build full message object
                    </span><span class="blue">$message </span><span class="green">=
                        </span><span class="blue">Message</span><span class="green">::</span><span class="blue">create</span><span class="green">()-&gt;
                        </span><span class="blue">setPerson</span><span class="green">(
                            </span><span class="blue">SecurityManager</span><span class="green">::</span><span class="blue">getUser</span><span class="green">()
                        )-&gt;
                        </span><span class="blue">setForumId</span><span class="green">(
                            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">message</span><span class="green">-&gt;</span><span class="blue">getForumId</span><span class="green">()
                        )-&gt;
                        </span><span class="blue">setParentId</span><span class="green">(
                            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">message</span><span class="green">-&gt;</span><span class="blue">getId</span><span class="green">()
                        )-&gt;
                        </span><span class="blue">setThreadId</span><span class="green">(
                            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">message</span><span class="green">-&gt;</span><span class="blue">getThreadId</span><span class="green">()
                        )-&gt;
                        </span><span class="blue">setName</span><span class="green">(
                            </span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getValue</span><span class="green">(</span><span class="red">'name'</span><span class="green">)
                        )-&gt;
                        </span><span class="blue">setContent</span><span class="green">(
                            </span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getValue</span><span class="green">(</span><span class="red">'content'</span><span class="green">)
                        );
                    
                    </span><span class="orange">// save it
                    </span><span class="blue">$message </span><span class="green">= </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">message</span><span class="green">()-&gt;</span><span class="blue">add</span><span class="green">(</span><span class="blue">$message</span><span class="green">);
                    
                    </span><span class="orange">// finally redirect to it's view
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FUtils%2FHeaderUtils.class.php&rev=0&sc=0">HeaderUtils</a></span><span class="green">::</span><span class="blue">redirect</span><span class="green">(
                        </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">setParameters</span><span class="green">(
                            array(
                                </span><span class="red">'id' </span><span class="green">=&gt; </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getId</span><span class="green">()
                            )
                        )
                    );

                    return </span><span class="blue">$this</span><span class="green">;
                }
            } else
                </span><span class="orange">// there was no user input
                </span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">dropAllErrors</span><span class="green">();
            
            try {
                </span><span class="orange">// get current thread message's list
                </span><span class="blue">$list </span><span class="green">= </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">message</span><span class="green">()-&gt;</span><span class="blue">getList</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FDAOs%2FObjectQuery.class.php&rev=0&sc=0">ObjectQuery</a></span><span class="green">::</span><span class="blue">create</span><span class="green">()-&gt;
                    </span><span class="blue">addLogic</span><span class="green">(
                        </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">eq</span><span class="green">(
                            </span><span class="red">'threadId'</span><span class="green">,
                            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">message</span><span class="green">-&gt;</span><span class="blue">getThreadId</span><span class="green">()
                        )
                    ),
                    </span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getActualValue</span><span class="green">(</span><span class="red">'unfold'</span><span class="green">)
                );
                
                </span><span class="orange">// build simple tree to simplify it's displaying
                </span><span class="green">foreach (</span><span class="blue">$list </span><span class="green">as &amp;</span><span class="blue">$message</span><span class="green">) {
                    if ((</span><span class="blue">$parentId </span><span class="green">= </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getParentId</span><span class="green">()) === </span><span class="blue">null</span><span class="green">)
                        </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">messageList</span><span class="green">[</span><span class="blue">0</span><span class="green">][] = </span><span class="blue">$message</span><span class="green">;
                    else
                        </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">messageList</span><span class="green">[</span><span class="blue">$parentId</span><span class="green">][] = </span><span class="blue">$message</span><span class="green">;
                }
                        
            } catch (</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FExceptions%2FObjectNotFoundException.class.php&rev=0&sc=0">ObjectNotFoundException</a> $e</span><span class="green">) {
                </span><span class="orange">// such thread does not even exist
                </span><span class="green">return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">blowOut</span><span class="green">(</span><span class="red">'forumList'</span><span class="green">);
            }
            
            return </span><span class="blue">$this</span><span class="green">;
        }

        <span class="orange">/* don't forget to include your favorite template at dump() */</span>
    }</span>
</pre>

<p>that's really <b>so</b> simple. you're almost <a href="..">onPHP</a>'s guru now, congratulations.</p>

<hr>

<!--# include file="heel.html" -->
