<pre>
    <span class="green">final class </span><span class="blue">threadList </span><span class="green">extends </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FModule%2FFormedModule.class.php&rev=0&sc=0">FormedModule</a>
    </span><span class="green">{
        const </span><span class="blue">PER_PAGE </span><span class="green">= </span><span class="blue">50</span><span class="green">;
        
        protected </span><span class="blue">$forum        </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        protected </span><span class="blue">$threadList   </span><span class="green">= </span><span class="blue">null</span><span class="green">;
        
        public function </span><span class="blue">init</span><span class="green">()
        {
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">form</span><span class="green">-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue">boolean</span><span class="green">(</span><span class="red">'post'</span><span class="green">)
                )-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitiveInteger.class.php&rev=0&sc=0">integer</a></span><span class="green">(</span><span class="red">'forumId'</span><span class="green">)-&gt;</span><span class="blue">required</span><span class="green">()
                )-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitiveInteger.class.php&rev=0&sc=0">integer</a></span><span class="green">(</span><span class="red">'page'</span><span class="green">)-&gt;</span><span class="blue">setDefault</span><span class="green">(</span><span class="blue">1</span><span class="green">)
                )-&gt;
                </span><span class="blue">import</span><span class="green">(</span><span class="blue">$_GET</span><span class="green">);

            </span><span class="orange">// forum's id is missing or invalid
            </span><span class="green">if (</span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">form</span><span class="green">-&gt;</span><span class="blue">getErrors</span><span class="green">())
                return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">blowOut</span><span class="green">();

            </span><span class="orange">// in case we're awaiting new message arrival
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">form</span><span class="green">-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitiveString.class.php&rev=0&sc=0">string</a></span><span class="green">(</span><span class="red">'name'</span><span class="green">)-&gt;</span><span class="blue">setMax</span><span class="green">(</span><span class="blue">255</span><span class="green">)-&gt;</span><span class="blue">required</span><span class="green">()-&gt;
                    </span><span class="blue">addImportFilter</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FFilter.class.php&rev=0&sc=0">Filter</a></span><span class="green">::</span><span class="blue">textImport</span><span class="green">())-&gt;
                    </span><span class="blue">addDisplayFilter</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FFilter.class.php&rev=0&sc=0">Filter</a></span><span class="green">::</span><span class="blue">htmlSpecialChars</span><span class="green">())
                )-&gt;
                </span><span class="blue">add</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitive.class.php&rev=0&sc=0">Primitive</a></span><span class="green">::</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FPrimitiveString.class.php&rev=0&sc=0">string</a></span><span class="green">(</span><span class="red">'content'</span><span class="green">)-&gt;</span><span class="blue">setMax</span><span class="green">(</span><span class="blue">40960</span><span class="green">)-&gt;</span><span class="blue">required</span><span class="green">()-&gt; </span><span class="orange">// ~40Kb
                    </span><span class="blue">addImportFilter</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FFilter.class.php&rev=0&sc=0">Filter</a></span><span class="green">::</span><span class="blue">textImport</span><span class="green">())-&gt;
                    </span><span class="blue">addDisplayFilter</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FForm%2FFilter.class.php&rev=0&sc=0">Filter</a></span><span class="green">::</span><span class="blue">htmlSpecialChars</span><span class="green">())
                )-&gt;
                </span><span class="blue">importMore</span><span class="green">(</span><span class="blue">$_POST</span><span class="green">);
            
            return </span><span class="blue">$this</span><span class="green">;
        }
        
        public function </span><span class="blue">process</span><span class="green">()
        {
            </span><span class="blue">$form </span><span class="green">= </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">form</span><span class="green">;
            
            try {
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">forum </span><span class="green">= </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">forum</span><span class="green">()-&gt;</span><span class="blue">getById</span><span class="green">(
                    </span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getValue</span><span class="green">(</span><span class="red">'forumId'</span><span class="green">)
                );
            } catch (</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FExceptions%2FObjectNotFoundException.class.php&rev=0&sc=0">ObjectNotFoundException</a> $e</span><span class="green">) {
                </span><span class="orange">// forum with such id does not exist
                </span><span class="green">return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">blowOut</span><span class="green">(</span><span class="red">'forumList'</span><span class="green">);
            }

            </span><span class="orange">// check POST-trigger
            </span><span class="green">if (</span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getValue</span><span class="green">(</span><span class="red">'post'</span><span class="green">)) {
                
                </span><span class="orange">// imaginary class to check user's permissions to post
                </span><span class="green">if (!</span><span class="blue">SecurityManager</span><span class="green">::</span><span class="blue">isLoggedIn</span><span class="green">())
                    return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">blowOut</span><span class="green">();
                
                </span><span class="orange">// if there are any errors,
                // user should correct them first
                </span><span class="green">if (</span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getErrors</span><span class="green">())
                    return </span><span class="blue">$this</span><span class="green">;
                
                </span><span class="orange">// ok, let's build new object
                </span><span class="blue">$message </span><span class="green">=
                    </span><span class="blue">Message</span><span class="green">::</span><span class="blue">create</span><span class="green">()-&gt;
                    </span><span class="blue">setPerson</span><span class="green">(
                        </span><span class="blue">SecurityManager</span><span class="green">::</span><span class="blue">getUser</span><span class="green">()
                    )-&gt;
                    </span><span class="blue">setForumId</span><span class="green">(
                        </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">forum</span><span class="green">-&gt;</span><span class="blue">getId</span><span class="green">()
                    )-&gt;
                    </span><span class="orange">// parent should be null
                    // thread will be set at DAO
                    </span><span class="blue">setName</span><span class="green">(
                        </span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getValue</span><span class="green">(</span><span class="red">'name'</span><span class="green">)
                    )-&gt;
                    </span><span class="blue">setContent</span><span class="green">(
                        </span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">getValue</span><span class="green">(</span><span class="red">'content'</span><span class="green">)
                    );
                
                </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">message</span><span class="green">()-&gt;</span><span class="blue">add</span><span class="green">(</span><span class="blue">$message</span><span class="green">);
                
                </span><span class="orange">// go back to thread's list
                </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FUtils%2FHeaderUtils.class.php&rev=0&sc=0">HeaderUtils</a></span><span class="green">::</span><span class="blue">redirect</span><span class="green">(
                    </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">setParameters</span><span class="green">(
                        array(
                            </span><span class="red">'forumId' </span><span class="green">=&gt; </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">forum</span><span class="green">-&gt;</span><span class="blue">getId</span><span class="green">()
                        )
                    )
                );
                
                return </span><span class="blue">$this</span><span class="green">;
                
            } else
                </span><span class="orange">// there was no POST-trigger,
                // so assume, there were no input
                </span><span class="blue">$form</span><span class="green">-&gt;</span><span class="blue">dropAllErrors</span><span class="green">();

            try {
                </span><span class="orange">// let's get this forum's threads list
                // sorted by creation time
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">threadList </span><span class="green">=
                    </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">message</span><span class="green">()-&gt;</span><span class="blue">getThreadList</span><span class="green">(
                        </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FDAOs%2FObjectQuery.class.php&rev=0&sc=0">ObjectQuery</a></span><span class="green">::</span><span class="blue">create</span><span class="green">()-&gt;
                        </span><span class="blue">addLogic</span><span class="green">(
                            </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">eqId</span><span class="green">(</span><span class="red">'forumId'</span><span class="green">, </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">forum</span><span class="green">)
                        )-&gt;
                        </span><span class="blue">sort</span><span class="green">(</span><span class="red">'created'</span><span class="green">)-&gt;</span><span class="blue">desc</span><span class="green">()
                    );
            } catch (</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FExceptions%2FObjectNotFoundException.class.php&rev=0&sc=0">ObjectNotFoundException</a> $e</span><span class="green">) {
                </span><span class="orange">// newly created, probably
            </span><span class="green">}
            
            return </span><span class="blue">$this</span><span class="green">;
        }
        
        </span><span class="orange">/* don't forget to include your favorite template at dump() */
    </span><span class="green">}</span>
</pre>