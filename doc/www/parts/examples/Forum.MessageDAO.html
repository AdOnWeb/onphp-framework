<pre>
    <span class="green">final class </span><span class="blue">MessageDAO </span><span class="green">extends </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FDAOs%2FMappedStorableDAO.class.php&rev=0&sc=0">MappedStorableDAO</a>
    </span><span class="green">{
        protected </span><span class="blue">$mapping </span><span class="green">= array(
            </span><span class="red">'id'          </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'name'        </span><span class="green">=&gt; </span><span class="blue">null</span><span class="green">,
            </span><span class="red">'forumId'     </span><span class="green">=&gt; </span><span class="red">'forum_id'</span><span class="green">,
            </span><span class="red">'personId'    </span><span class="green">=&gt; </span><span class="red">'person_id'</span><span class="green">,
            </span><span class="red">'parentId'    </span><span class="green">=&gt; </span><span class="red">'parent_id'</span><span class="green">,
            </span><span class="red">'threadId'    </span><span class="green">=&gt; </span><span class="red">'thread_id'</span><span class="green">,
            </span><span class="red">'created'     </span><span class="green">=&gt; </span><span class="blue">null
            </span><span class="orange">// 'content' hided from default fields/mapping
        </span><span class="green">);
        
        public function </span><span class="blue">getTable</span><span class="green">()
        {
            return </span><span class="red">'message'</span><span class="green">;
        }
        
        public function </span><span class="blue">getBodyTable</span><span class="green">()
        {
            return </span><span class="red">'message_body'</span><span class="green">;
        }
        
        public function </span><span class="blue">getObjectName</span><span class="green">()
        {
            return </span><span class="red">'Message'</span><span class="green">;
        }
        
        </span><span class="orange">// wrappers
        </span><span class="green">public function </span><span class="blue">getById</span><span class="green">(</span><span class="blue">$id</span><span class="green">, </span><span class="blue">$full </span><span class="green">= </span><span class="blue">false</span><span class="green">)
        {
            </span><span class="blue">$query </span><span class="green">=
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">makeSelectHead</span><span class="green">()-&gt;
                </span><span class="blue">where</span><span class="green">(
                    </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">eq</span><span class="green">(
                        </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FDBField.class.php&rev=0&sc=0">DBField</a></span><span class="green">::</span><span class="blue">create</span><span class="green">(</span><span class="red">'id'</span><span class="green">, </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getTable</span><span class="green">()),
                        </span><span class="blue">$id
                    </span><span class="green">)
                );
            
            if (</span><span class="blue">$full</span><span class="green">)
                </span><span class="blue">$query</span><span class="green">-&gt;</span><span class="blue">get</span><span class="green">(</span><span class="red">'content'</span><span class="green">);
            
            return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getByQuery</span><span class="green">(</span><span class="blue">$query</span><span class="green">);
        }
        
        public function </span><span class="blue">getList</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FDAOs%2FObjectQuery.class.php&rev=0&sc=0">ObjectQuery</a> $oq</span><span class="green">, </span><span class="blue">$full </span><span class="green">= </span><span class="blue">false</span><span class="green">)
        {
            </span><span class="blue">$query </span><span class="green">= </span><span class="blue">$oq</span><span class="green">-&gt;</span><span class="blue">toSelectQuery</span><span class="green">(</span><span class="blue">$this</span><span class="green">);
            
            if (</span><span class="blue">$full</span><span class="green">)
                </span><span class="blue">$query</span><span class="green">-&gt;</span><span class="blue">get</span><span class="green">(</span><span class="red">'content'</span><span class="green">);
            
            return </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getListByQuery</span><span class="green">(</span><span class="blue">$query</span><span class="green">);
        }
        
        public function </span><span class="blue">makeObject</span><span class="green">(&amp;</span><span class="blue">$array</span><span class="green">, </span><span class="blue">$prefix </span><span class="green">= </span><span class="blue">null</span><span class="green">)
        {
            return
                </span><span class="blue">Message</span><span class="green">::</span><span class="blue">create</span><span class="green">()-&gt;
                </span><span class="blue">setId</span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'id'</span><span class="green">])-&gt;
                </span><span class="blue">setName</span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'name'</span><span class="green">])-&gt;
                </span><span class="blue">setCreated</span><span class="green">(new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FTimestamp.class.php&rev=0&sc=0">Timestamp</a></span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'created'</span><span class="green">]))-&gt;
                </span><span class="blue">setForumId</span><span class="green">(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'forum_id'</span><span class="green">])-&gt;
                </span><span class="blue">setPerson</span><span class="green">(
                    </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">person</span><span class="green">()-&gt;</span><span class="blue">getById</span><span class="green">(
                        </span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'person_id'</span><span class="green">]
                    )
                )-&gt;
                </span><span class="blue">setContent</span><span class="green">(
                    isset(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'content'</span><span class="green">])
                        ? </span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'content'</span><span class="green">]
                        : </span><span class="blue">null
                </span><span class="green">)-&gt;
                </span><span class="orange">// null when top level
                </span><span class="blue">setParentId</span><span class="green">(
                    isset(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'parent_id'</span><span class="green">])
                        ? </span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'parent_id'</span><span class="green">]
                        : </span><span class="blue">null
                </span><span class="green">)-&gt;
                </span><span class="blue">setThreadId</span><span class="green">(
                    isset(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'thread_id'</span><span class="green">])
                        ? </span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'thread_id'</span><span class="green">]
                        : </span><span class="blue">null
                </span><span class="green">)-&gt;
                </span><span class="blue">setChildsCount</span><span class="green">(
                    isset(</span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'count'</span><span class="green">])
                        ? </span><span class="blue">$array</span><span class="green">[</span><span class="blue">$prefix</span><span class="green">.</span><span class="red">'count'</span><span class="green">]
                        : </span><span class="blue">null
                </span><span class="green">);
        }
        
        public function </span><span class="blue">setQueryFields</span><span class="green">(
            </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FInsertOrUpdateQuery.class.php&rev=0&sc=0">InsertOrUpdateQuery</a> $query</span><span class="green">, </span><span class="blue">Message $message
        </span><span class="green">)
        {
            if (</span><span class="blue">$query </span><span class="green">instanceof </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FInsertQuery.class.php&rev=0&sc=0">InsertQuery</a></span><span class="green">)
                </span><span class="blue">$query</span><span class="green">-&gt;</span><span class="blue">set</span><span class="green">(
                    </span><span class="red">'created'</span><span class="green">,
                    </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">setCreated</span><span class="green">(new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FTimestamp.class.php&rev=0&sc=0">Timestamp</a></span><span class="green">(</span><span class="blue">time</span><span class="green">()))-&gt;
                        </span><span class="blue">getCreated</span><span class="green">()-&gt;</span><span class="blue">toString</span><span class="green">()
                );
            
            return
                </span><span class="blue">$query</span><span class="green">-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'id'</span><span class="green">,             </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getId</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'name'</span><span class="green">,           </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getName</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'content'</span><span class="green">,        </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getContent</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'forum_id'</span><span class="green">,       </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getForumId</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'person_id'</span><span class="green">,      </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getPerson</span><span class="green">()-&gt;</span><span class="blue">getId</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'parent_id'</span><span class="green">,      </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getParentId</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'thread_id'</span><span class="green">,      </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getThreadId</span><span class="green">())-&gt;
                    </span><span class="blue">set</span><span class="green">(</span><span class="red">'created'</span><span class="green">,        </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getCreated</span><span class="green">()-&gt;</span><span class="blue">toString</span><span class="green">());
        }
        
        public function </span><span class="blue">getThreadList</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FDAOs%2FObjectQuery.class.php&rev=0&sc=0">ObjectQuery</a> $oq</span><span class="green">)
        {
            return
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getQueryResult</span><span class="green">(
                    </span><span class="blue">$oq</span><span class="green">-&gt;</span><span class="blue">toSelectQuery</span><span class="green">(</span><span class="blue">$this</span><span class="green">)-&gt;
                    </span><span class="blue">get</span><span class="green">(
                        </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FOSQL.class.php&rev=0&sc=0">OSQL</a></span><span class="green">::</span><span class="blue">select</span><span class="green">()-&gt;</span><span class="blue">from</span><span class="green">(</span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getTable</span><span class="green">(), </span><span class="red">'sub'</span><span class="green">)-&gt;
                        </span><span class="blue">get</span><span class="green">(
                            </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">sub</span><span class="green">(
                                </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FSQLFunction.class.php&rev=0&sc=0">SQLFunction</a></span><span class="green">::</span><span class="blue">create</span><span class="green">(</span><span class="red">'count'</span><span class="green">, </span><span class="red">'id'</span><span class="green">),
                                new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FDBValue.class.php&rev=0&sc=0">DBValue</a></span><span class="green">(</span><span class="blue">1</span><span class="green">)
                            )
                        )-&gt;
                        </span><span class="blue">where</span><span class="green">(
                            </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">eq</span><span class="green">(
                                new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FDBField.class.php&rev=0&sc=0">DBField</a></span><span class="green">(</span><span class="red">'thread_id'</span><span class="green">, </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getTable</span><span class="green">()),
                                new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FDBField.class.php&rev=0&sc=0">DBField</a></span><span class="green">(</span><span class="red">'thread_id'</span><span class="green">, </span><span class="red">'sub'</span><span class="green">)
                            )
                        )-&gt;
                        </span><span class="blue">setName</span><span class="green">(</span><span class="red">'count'</span><span class="green">)
                    )-&gt;
                    </span><span class="blue">andWhere</span><span class="green">(
                        </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">isNull</span><span class="green">(</span><span class="red">'parent_id'</span><span class="green">)
                    )
                );
        }
        
        protected function </span><span class="blue">inject</span><span class="green">(
            </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FInsertOrUpdateQuery.class.php&rev=0&sc=0">InsertOrUpdateQuery</a> $query</span><span class="green">, </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FIdentifiable.class.php&rev=0&sc=0">Identifiable</a> $message
        </span><span class="green">)
        {
            </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FBase%2FAssert.class.php&rev=0&sc=0">Assert</a></span><span class="green">::</span><span class="blue">isTrue</span><span class="green">(</span><span class="blue">$message </span><span class="green">instanceof </span><span class="blue">Message</span><span class="green">); </span><span class="orange">// paranoia
            
            // we should update 'modified' and 'message_count' there
            </span><span class="blue">$forumQuery </span><span class="green">= </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FOSQL.class.php&rev=0&sc=0">OSQL</a></span><span class="green">::</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FUpdateQuery.class.php&rev=0&sc=0">update</a></span><span class="green">(</span><span class="blue">DAO</span><span class="green">::</span><span class="blue">forum</span><span class="green">()-&gt;</span><span class="blue">getTable</span><span class="green">());
            
            if (</span><span class="blue">$query </span><span class="green">instanceof </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FInsertQuery.class.php&rev=0&sc=0">InsertQuery</a></span><span class="green">) {
                if (</span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getThreadId</span><span class="green">() === </span><span class="blue">null</span><span class="green">)
                    </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">setThreadId</span><span class="green">(
                        </span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getId</span><span class="green">()
                    );

                </span><span class="orange">// increase message counter upon message addition
                </span><span class="blue">$forumQuery</span><span class="green">-&gt;
                    </span><span class="blue">set</span><span class="green">(
                        </span><span class="red">'message_count'</span><span class="green">,
                        </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FLogic%2FExpression.class.php&rev=0&sc=0">Expression</a></span><span class="green">::</span><span class="blue">add</span><span class="green">(
                            new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FDBField.class.php&rev=0&sc=0">DBField</a></span><span class="green">(</span><span class="red">'message_count'</span><span class="green">),
                            new </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FDBValue.class.php&rev=0&sc=0">DBValue</a></span><span class="green">(</span><span class="blue">1</span><span class="green">)
                        )
                    );
            }
            
            </span><span class="orange">// modification time should be set
            // on every message-realted action
            </span><span class="blue">$forumQuery</span><span class="green">-&gt;
                </span><span class="blue">set</span><span class="green">(</span><span class="red">'modified'</span><span class="green">, </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FOSQL%2FSQLFunction.class.php&rev=0&sc=0">SQLFunction</a></span><span class="green">::</span><span class="blue">create</span><span class="green">(</span><span class="red">'now'</span><span class="green">));

            </span><span class="orange">// go
            </span><span class="blue">Transaction</span><span class="green">::</span><span class="blue">immediate</span><span class="green">(</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FDB%2FDBFactory.class.php&rev=0&sc=0">DBFactory</a></span><span class="green">::</span><span class="blue">getDefaultInstance</span><span class="green">())-&gt;
            </span><span class="blue">add</span><span class="green">(
                </span><span class="orange">// main query
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">setQueryFields</span><span class="green">(
                    </span><span class="blue">$query</span><span class="green">-&gt;</span><span class="blue">setTable</span><span class="green">(</span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">getTable</span><span class="green">()),
                    </span><span class="blue">$message
                </span><span class="green">)
            )-&gt;
            </span><span class="blue">add</span><span class="green">(
                </span><span class="orange">// forum' update query
                </span><span class="blue">$forumQuery
            </span><span class="green">)-&gt;
            </span><span class="blue">flush</span><span class="green">();
            
            </span><span class="orange">// drop all message-related lists from cache
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">dropLists</span><span class="green">();
            
            </span><span class="orange">// uncache message's forum object
            </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">forum</span><span class="green">()-&gt;</span><span class="blue">uncacheById</span><span class="green">(</span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getForumId</span><span class="green">());
            
            </span><span class="orange">// uncache message, if any
            </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">uncacheById</span><span class="green">(</span><span class="blue">$message</span><span class="green">-&gt;</span><span class="blue">getId</span><span class="green">());
            
            return </span><span class="blue">$message</span><span class="green">;
        }
    }</span>
</pre>

<p>so here goes our business logic (all view-templates are omitted), list of available forums:</p>

<pre>
    <span class="green">final class </span><span class="blue">forumList </span><span class="green">extends </span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fmain%2FModule%2FBaseModule.class.php&rev=0&sc=0">BaseModule</a>
    </span><span class="green">{
        protected </span><span class="blue">$plainList </span><span class="green">= array();
        
        public function </span><span class="blue">process</span><span class="green">()
        {
            try {
                </span><span class="blue">$this</span><span class="green">-&gt;</span><span class="blue">forumList </span><span class="green">= </span><span class="blue">DAO</span><span class="green">::</span><span class="blue">forum</span><span class="green">()-&gt;</span><span class="blue">getPlainList</span><span class="green">();
            } catch (</span><span class="blue"><a href="http://svn.shadanakar.org/filedetails.php?repname=onPHP&path=%2Ftrunk%2Fcore%2FExceptions%2FObjectNotFoundException.class.php&rev=0&sc=0">ObjectNotFoundException</a> $e</span><span class="green">) {
                </span><span class="orange">// no forums created yet
            </span><span class="green">}
            
            return </span><span class="blue">$this</span><span class="green">;
        }
        
        </span><span class="orange">/* don't forget to include your favorite template at dump() */
    </span><span class="green">}</span>
</pre>